<!DOCTYPE html>
<html>
<head>
  <title>전화번호 인증</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
    }
    .container {
      border: 1px solid #ddd;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 5px;
    }
    .hidden {
      display: none;
    }
    input, button {
      padding: 10px;
      margin: 10px 0;
      width: 100%;
      box-sizing: border-box;
    }
    button {
      background-color: #4285F4;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    #result {
      background-color: #f5f5f5;
      padding: 15px;
      border-radius: 5px;
      font-family: monospace;
      white-space: pre-wrap;
      word-break: break-all;
    }
  </style>
</head>
<body>
<h1>전화번호 인증</h1>

<div class="container">
  <div id="phone-container">
    <label for="phone">전화번호:</label>
    <input type="tel" id="phone" placeholder="+821012345678">
    <div id="recaptcha-container"></div>
    <button id="send-code-btn">인증번호 발송</button>
  </div>

  <div id="code-container" class="hidden">
    <label for="code">인증번호:</label>
    <input type="text" id="code" placeholder="인증번호 6자리">
    <button id="verify-code-btn">인증하기</button>
  </div>
</div>

<div class="container">
  <h3>결과</h3>
  <div id="result">인증 결과가 여기에 표시됩니다.</div>
</div>

<script>
  // Firebase 초기화
  const firebaseConfig = {
    apiKey: "YOUR_FIREBASE_API_KEY",
    authDomain: "your-project-id.firebaseapp.com",
    projectId: "your-project-id",
    storageBucket: "your-project-id.appspot.com",
    messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  firebase.initializeApp(firebaseConfig);

  let phoneNumber = '';
  let confirmationResult = null;

  // 화면 전환 함수
  function showContainer(containerId) {
    document.getElementById('phone-container').classList.add('hidden');
    document.getElementById('code-container').classList.add('hidden');

    document.getElementById(containerId).classList.remove('hidden');
  }

  // 결과 표시 함수
  function showResult(message) {
    if (typeof message === 'object') {
      message = JSON.stringify(message, null, 2);
    }
    document.getElementById('result').textContent = message;
  }

  // reCAPTCHA 초기화
  window.onload = function() {
    window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
      'size': 'normal',
      'callback': (response) => {
        // reCAPTCHA 인증 성공
        document.getElementById('send-code-btn').disabled = false;
      }
    });
    window.recaptchaVerifier.render();
  };

  // 인증번호 발송
  document.getElementById('send-code-btn').addEventListener('click', async () => {
    phoneNumber = document.getElementById('phone').value.trim();

    if (!phoneNumber) {
      showResult('전화번호를 입력하세요.');
      return;
    }

    try {
      showResult('인증번호 발송 중...');

      // Firebase 인증번호 발송
      confirmationResult = await firebase.auth().signInWithPhoneNumber(
          phoneNumber,
          window.recaptchaVerifier
      );

      showResult('인증번호가 발송되었습니다.');
      showContainer('code-container');
    } catch (error) {
      showResult(`인증번호 발송 실패: ${error.message}`);
    }
  });

  // 인증번호 확인
  document.getElementById('verify-code-btn').addEventListener('click', async () => {
    const code = document.getElementById('code').value.trim();

    if (!code) {
      showResult('인증번호를 입력하세요.');
      return;
    }

    try {
      showResult('인증번호 확인 중...');

      // Firebase 인증번호 확인
      const result = await confirmationResult.confirm(code);

      // ID 토큰 획득
      const idToken = await result.user.getIdToken();

      // 백엔드 API 호출하여 인증 완료 처리
      const response = await fetch('/api/auth/phone/verify', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          phoneNumber: phoneNumber,
          idToken: idToken
        })
      });

      const data = await response.json();

      if (!response.ok) {
        if (data.needRegistration) {
          showResult({
            message: '인증은 성공했으나 계정이 존재하지 않습니다. 회원가입이 필요합니다.',
            error: data.error
          });
          // 회원가입 페이지로 리다이렉트 로직 추가 가능
          return;
        }

        throw new Error(data.error || '서버 오류가 발생했습니다.');
      }

      showResult({
        message: '전화번호 인증이 완료되었습니다.',
        data: data
      });

      // JWT 토큰 로컬 스토리지에 저장 (실제 서비스에서는 보안을 고려하여 구현)
      localStorage.setItem('accessToken', data.accessToken);
      localStorage.setItem('refreshToken', data.refreshToken);

      // 메인 페이지로 리다이렉트 로직 추가 가능
      // window.location.href = '/home';

    } catch (error) {
      showResult(`인증 실패: ${error.message}`);
    }
  });
</script>
</body>
</html>