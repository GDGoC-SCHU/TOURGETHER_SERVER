<!DOCTYPE html>
<html>
<head>
  <title>전화번호 인증</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <style>
    body {
      font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
      max-width: 500px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f7f8fa;
      color: #333;
    }
    .container {
      background-color: white;
      border-radius: 10px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }
    h1 {
      color: #333;
      font-size: 24px;
      margin-bottom: 25px;
      text-align: center;
    }
    .hidden {
      display: none;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #555;
    }
    .input-group {
      display: flex;
      margin-bottom: 15px;
    }
    select.country-code {
      padding: 12px;
      border: 1px solid #ddd;
      border-right: none;
      border-radius: 5px 0 0 5px;
      background-color: #f5f5f5;
      min-width: 90px;
      font-size: 16px;
      color: #333;
    }
    select.country-code:focus {
      outline: none;
      border-color: #4285F4;
    }
    input {
      flex: 1;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 0 5px 5px 0;
      font-size: 16px;
    }
    input:focus {
      outline: none;
      border-color: #4285F4;
    }
    button {
      background-color: #4285F4;
      color: white;
      border: none;
      padding: 12px;
      width: 100%;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 500;
      font-size: 16px;
      margin-top: 10px;
      transition: background-color 0.2s;
    }
    button:hover {
      background-color: #3367d6;
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    .alert {
      padding: 12px 15px;
      border-radius: 5px;
      margin-bottom: 15px;
      font-size: 14px;
    }
    .alert-success {
      background-color: #e7f6ea;
      color: #2e7d32;
    }
    .alert-error {
      background-color: #fdeded;
      color: #d32f2f;
    }
    .timer {
      text-align: right;
      font-size: 14px;
      color: #f44336;
      margin-top: 5px;
      margin-bottom: 15px;
    }
    .verification-code {
      letter-spacing: 5px;
      font-size: 18px;
    }
    #recaptcha-container {
      margin: 15px 0;
    }
  </style>
</head>
<body>
<h1>전화번호 인증</h1>

<div class="container" id="step1">
  <label for="phone">전화번호</label>
  <div class="input-group">
    <select id="country-code" class="country-code">
      <option value="+82" selected>+82 (대한민국)</option>
      <option value="+1">+1 (미국/캐나다)</option>
      <option value="+44">+44 (영국)</option>
      <option value="+81">+81 (일본)</option>
      <option value="+86">+86 (중국)</option>
      <option value="+852">+852 (홍콩)</option>
      <option value="+65">+65 (싱가포르)</option>
      <option value="+886">+886 (대만)</option>
      <option value="+66">+66 (태국)</option>
      <option value="+84">+84 (베트남)</option>
      <option value="+63">+63 (필리핀)</option>
      <option value="+62">+62 (인도네시아)</option>
      <option value="+60">+60 (말레이시아)</option>
      <option value="+61">+61 (호주)</option>
      <option value="+64">+64 (뉴질랜드)</option>
      <option value="+49">+49 (독일)</option>
      <option value="+33">+33 (프랑스)</option>
      <option value="+39">+39 (이탈리아)</option>
      <option value="+34">+34 (스페인)</option>
      <option value="+7">+7 (러시아)</option>
    </select>
    <input type="tel" id="phone" placeholder="전화번호 입력 (- 없이)" autocomplete="tel">
  </div>
  <p class="input-helper" style="margin-top: -5px; font-size: 13px; color: #888;">예시: 01012345678</p>
  <div id="phone-error" class="alert alert-error hidden"></div>
  <div id="recaptcha-container"></div>
  <button id="send-code-btn">인증번호 발송</button>
</div>

<div class="container hidden" id="step2">
  <div class="alert alert-success">
    입력하신 전화번호로 인증번호가 발송되었습니다.
  </div>
  <label for="code">인증번호</label>
  <input type="text" id="code" class="verification-code" placeholder="6자리 인증번호" maxlength="6">
  <div class="timer" id="timer">05:00</div>
  <div id="code-error" class="alert alert-error hidden"></div>
  <button id="verify-code-btn">인증 완료</button>
  <button id="resend-code-btn" style="background-color: #f1f3f5; color: #666; margin-top: 10px;">인증번호 재발송</button>
</div>

<div id="message-container" class="container hidden">
  <div id="result-message" class="alert"></div>
</div>

<script>
  // Firebase 초기화
  const firebaseConfig = {
    apiKey: "AIzaSyCbHQQxtNtc_TTjUxC5J_CuXeveCVJ_ip0",
    authDomain: "tripmate-test-18915.firebaseapp.com",
    projectId: "tripmate-test-18915",
    storageBucket: "tripmate-test-18915.firebasestorage.app",
    messagingSenderId: "344101713187",
    appId: "1:344101713187:web:f9b10b5f89d4803d428896",
    measurementId: "G-9LMRS0F0TW"
  };

  firebase.initializeApp(firebaseConfig);

  // 초기화
  let confirmationResult = null;
  let countdownInterval = null;
  let timeLeft = 300; // 5분

  // URL 파라미터 가져오기
  function getUrlParam(param) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(param);
  }

  // 사용자 ID 가져오기
  const userId = getUrlParam('userId');

  // 화면 전환 함수
  function showStep(step) {
    document.getElementById('step1').classList.add('hidden');
    document.getElementById('step2').classList.add('hidden');
    document.getElementById('message-container').classList.add('hidden');

    if (step === 1) {
      document.getElementById('step1').classList.remove('hidden');
    } else if (step === 2) {
      document.getElementById('step2').classList.remove('hidden');
      startTimer();
    } else if (step === 'message') {
      document.getElementById('message-container').classList.remove('hidden');
    }
  }

  // 메시지 표시 함수
  function showMessage(message, isSuccess = true) {
    const messageEl = document.getElementById('result-message');

    messageEl.textContent = message;
    messageEl.classList.remove('alert-error', 'alert-success');
    messageEl.classList.add(isSuccess ? 'alert-success' : 'alert-error');

    showStep('message');
  }

  // 오류 메시지 표시 함수
  function showError(elementId, message) {
    const element = document.getElementById(elementId);
    element.textContent = message;
    element.classList.remove('hidden');
  }

  // 오류 메시지 숨기기 함수
  function hideError(elementId) {
    const element = document.getElementById(elementId);
    element.classList.add('hidden');
  }

  // 타이머 시작 함수
  function startTimer() {
    timeLeft = 300; // 5분으로 초기화
    updateTimerDisplay();

    if (countdownInterval) {
      clearInterval(countdownInterval);
    }

    countdownInterval = setInterval(() => {
      timeLeft--;
      updateTimerDisplay();

      if (timeLeft <= 0) {
        clearInterval(countdownInterval);
        showError('code-error', '인증 시간이 만료되었습니다. 인증번호를 재발송해주세요.');
        document.getElementById('verify-code-btn').disabled = true;
      }
    }, 1000);
  }

  // 타이머 표시 업데이트
  function updateTimerDisplay() {
    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;
    document.getElementById('timer').textContent =
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
  }

  // 페이지 로드 시 실행
  window.onload = function() {
    // reCAPTCHA 초기화
    window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
      'size': 'normal',
      'callback': (response) => {
        // reCAPTCHA 인증 성공
        document.getElementById('send-code-btn').disabled = false;
      }
    });
    window.recaptchaVerifier.render();

    // 전화번호 입력 필드에 포커스
    document.getElementById('phone').focus();

    // 국가 코드에 따른 전화번호 입력 힌트 업데이트
    document.getElementById('country-code').addEventListener('change', updatePhonePlaceholder);

    // 초기 힌트 설정
    updatePhonePlaceholder();
  };

  // 국가 코드에 따른 입력 힌트 업데이트
  function updatePhonePlaceholder() {
    const countryCode = document.getElementById('country-code').value;
    const phoneInput = document.getElementById('phone');
    const helperText = document.querySelector('.input-helper');

    if (countryCode === '+82') {
      phoneInput.placeholder = "전화번호 입력 (- 없이)";
      helperText.textContent = "예시: 01012345678";
    } else if (countryCode === '+1') {
      phoneInput.placeholder = "Area code and number";
      helperText.textContent = "예시: 2125551234";
    } else {
      phoneInput.placeholder = "전화번호 입력";
      helperText.textContent = "지역번호를 포함한 전화번호를 입력하세요";
    }
  }

  // 전화번호 형식 변환 함수
  function formatPhoneNumber(phoneNumber, countryCode) {
    // 전화번호에서 숫자만 추출
    const cleanNumber = phoneNumber.replace(/\D/g, '');

    // 한국 번호인 경우 처리
    if (countryCode === '+82' && cleanNumber.startsWith('0')) {
      return countryCode + cleanNumber.substring(1);
    }

    // 다른 국가 번호
    return countryCode + cleanNumber;
  }

  // 인증번호 발송
  document.getElementById('send-code-btn').addEventListener('click', async () => {
    // 오류 메시지 초기화
    hideError('phone-error');

    // 전화번호 가져오기
    const phoneInput = document.getElementById('phone').value.trim();
    const countryCode = document.getElementById('country-code').value;

    if (!phoneInput) {
      showError('phone-error', '전화번호를 입력해주세요.');
      return;
    }

    // 국가별 전화번호 형식 검증
    let phoneRegex;
    if (countryCode === '+82') {
      phoneRegex = /^0?1[0-9]{8,9}$/; // 한국 전화번호 형식
    } else {
      phoneRegex = /^[0-9]{6,15}$/; // 일반적인 전화번호 형식
    }

    if (!phoneRegex.test(phoneInput.replace(/\D/g, ''))) {
      showError('phone-error', '올바른 전화번호 형식이 아닙니다.');
      return;
    }

    // 전화번호 형식 변환 (국가 코드 포함)
    const formattedPhone = formatPhoneNumber(phoneInput, countryCode);

    try {
      // 버튼 비활성화
      document.getElementById('send-code-btn').disabled = true;

      // Firebase 인증번호 발송
      confirmationResult = await firebase.auth().signInWithPhoneNumber(
          formattedPhone,
          window.recaptchaVerifier
      );

      // 다음 단계로 이동
      showStep(2);

      // 인증번호 입력 필드에 포커스
      setTimeout(() => {
        document.getElementById('code').focus();
      }, 100);
    } catch (error) {
      console.error('인증번호 발송 오류:', error);

      // 오류 메시지 표시
      let errorMessage = '인증번호 발송에 실패했습니다.';

      if (error.code === 'auth/invalid-phone-number') {
        errorMessage = '유효하지 않은 전화번호입니다.';
      } else if (error.code === 'auth/quota-exceeded') {
        errorMessage = '너무 많은 인증 시도가 있었습니다. 잠시 후 다시 시도해주세요.';
      }

      showError('phone-error', errorMessage);

      // reCAPTCHA 재설정
      window.recaptchaVerifier.render().then(function(widgetId) {
        grecaptcha.reset(widgetId);
      });

      // 버튼 활성화
      document.getElementById('send-code-btn').disabled = false;
    }
  });

  // 인증번호 재발송
  document.getElementById('resend-code-btn').addEventListener('click', () => {
    // 첫 단계로 돌아가기
    showStep(1);

    // 타이머 정지
    if (countdownInterval) {
      clearInterval(countdownInterval);
    }

    // reCAPTCHA 재설정
    window.recaptchaVerifier.render().then(function(widgetId) {
      grecaptcha.reset(widgetId);
    });
  });

  // 인증번호 확인
  document.getElementById('verify-code-btn').addEventListener('click', async () => {
    // 오류 메시지 초기화
    hideError('code-error');

    const code = document.getElementById('code').value.trim();

    if (!code) {
      showError('code-error', '인증번호를 입력해주세요.');
      return;
    }

    if (code.length !== 6 || !/^\d+$/.test(code)) {
      showError('code-error', '인증번호는 6자리 숫자여야 합니다.');
      return;
    }

    try {
      // 버튼 비활성화
      document.getElementById('verify-code-btn').disabled = true;
      document.getElementById('resend-code-btn').disabled = true;

      // 타이머 정지
      if (countdownInterval) {
        clearInterval(countdownInterval);
      }

      // Firebase 인증번호 확인
      const result = await confirmationResult.confirm(code);

      // ID 토큰 획득
      const idToken = await result.user.getIdToken();

      // 백엔드 API 호출
      const apiUrl = userId
          ? `/api/auth/phone/verify/${userId}` // 기존 사용자 업데이트
          : '/api/auth/phone/verify';          // 전화번호로 로그인

      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          idToken: idToken
        })
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.message || '서버 오류가 발생했습니다.');
      }

      // 인증 성공 메시지
      showMessage('전화번호 인증이 완료되었습니다.');

      // JWT 토큰 저장 (있는 경우)
      if (data.accessToken) {
        localStorage.setItem('accessToken', data.accessToken);
        localStorage.setItem('refreshToken', data.refreshToken);
      }

      // 성공 후 리다이렉트 (선택적)
      setTimeout(() => {
        const redirectUrl = getUrlParam('redirect') || '/';
        window.location.href = redirectUrl;
      }, 1500);

    } catch (error) {
      console.error('인증 오류:', error);

      // 오류 메시지 표시
      let errorMessage = '인증에 실패했습니다.';

      if (error.code === 'auth/invalid-verification-code') {
        errorMessage = '잘못된 인증번호입니다. 다시 확인해주세요.';
      } else if (error.code === 'auth/code-expired') {
        errorMessage = '인증번호가 만료되었습니다. 인증번호를 재발송해주세요.';
      }

      showError('code-error', errorMessage);

      // 버튼 활성화
      document.getElementById('verify-code-btn').disabled = false;
      document.getElementById('resend-code-btn').disabled = false;
    }
  });

  // 코드 입력 필드 자동 포커스 이동
  document.getElementById('code').addEventListener('input', function(e) {
    if (e.target.value.length === 6) {
      // 최대 길이 도달 시 버튼에 포커스
      document.getElementById('verify-code-btn').focus();
    }
  });
</script>
</body>
</html>